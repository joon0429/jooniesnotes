<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notepad - Joon's Notes</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <nav>
        <div class="nav-links">
            <a href="index.html">home</a>
            <a href="blog.html">blog</a>
            <a href="private.html">private notes</a>
            <div class="links-dropdown">
                <a href="#">links</a>
                <div class="links-dropdown-menu">
                    <a href="https://www.instagram.com/joonkwonn/" target="_blank">personal instagram</a>
                    <a href="https://www.instagram.com/jooniesflowerss/" target="_blank">flower instagram</a>
                    <a href="https://www.youtube.com/@joonkwonn" target="_blank">youtube channel</a>
                    <a href="https://www.linkedin.com/in/joonkwonn/" target="_blank">linkedin</a>
                </div>
            </div>
            <a href="resume.html">resume</a>
        </div>
        <div class="nav-right">
            <div class="theme-selector-nav">
                <select id="theme-select" onchange="changeThemeFromNav(this.value)">
                    <option value="light">light</option>
                    <option value="dark-pink">dark pink</option>
                    <option value="blue">blue</option>
                    <option value="green">green</option>
                    <option value="purple">purple</option>
                </select>
            </div>
            <a href="settings.html" class="settings-btn">settings</a>
        </div>
    </nav>
    <main class="notepad-container">
        <div id="password-prompt" class="password-prompt" style="display: none;">
            <h2>enter password</h2>
            <input type="password" id="note-password-input" placeholder="note password">
            <button onclick="checkNotePassword()">open note</button>
            <p id="note-password-error" class="error"></p>
        </div>
        <div id="notepad-content" style="display: none;">
            <!-- Notepad Menu Bar -->
            <div class="notepad-menubar">
                <div class="menu-item" onclick="toggleMenu('file-menu')">
                    file
                    <div id="file-menu" class="dropdown-menu">
                        <div onclick="saveNote()">save</div>
                        <div onclick="deleteNote()">delete</div>
                        <div onclick="window.location.href = document.querySelector('input[name=\"save-type\"]:checked').value === 'public' ? 'blog.html' : 'private.html'">exit</div>
                    </div>
                </div>
                <div class="menu-item" onclick="toggleMenu('edit-menu')">
                    edit
                    <div id="edit-menu" class="dropdown-menu">
                        <div onclick="document.getElementById('notepad-textarea').select(); document.execCommand('copy');">copy</div>
                        <div onclick="document.execCommand('paste');">paste</div>
                        <div onclick="document.execCommand('selectAll');">select all</div>
                    </div>
                </div>
                <div class="menu-item" onclick="toggleMenu('format-menu')">
                    format
                    <div id="format-menu" class="dropdown-menu">
                        <div onclick="applyFormatting('bold')">bold</div>
                        <div onclick="applyFormatting('italic')">italic</div>
                        <div onclick="applyFormatting('underline')">underline</div>
                        <div style="border-top: 1px solid #ccc; margin: 4px 0;"></div>
                        <div onclick="toggleViewMode()">
                            <span id="view-mode-text">view: text</span>
                        </div>
                    </div>
                </div>
                <div class="menu-item" onclick="toggleMenu('view-menu')">
                    view
                    <div id="view-menu" class="dropdown-menu">
                        <div onclick="openThemeSelector()">theme</div>
                    </div>
                </div>
                <div class="menu-item" onclick="toggleMenu('help-menu')">
                    help
                    <div id="help-menu" class="dropdown-menu">
                        <div onclick="alert('markdown supported: # headers, **bold**, *italic*, - lists, [links](url)')">about markdown</div>
                    </div>
                </div>
            </div>
            
            <!-- Notepad Toolbar (minimal, like Notepad) -->
            <div class="notepad-toolbar">
                <input type="text" id="note-title" placeholder="untitled" class="title-input">
                <div class="formatting-buttons">
                    <button class="format-btn" onclick="applyFormatting('bold')" title="bold (ctrl+b)"><strong>B</strong></button>
                    <button class="format-btn" onclick="applyFormatting('italic')" title="italic (ctrl+i)"><em>I</em></button>
                    <button class="format-btn" onclick="applyFormatting('underline')" title="underline (ctrl+u)"><u>U</u></button>
                </div>
                <div class="toolbar-right">
                    <label class="file-upload-btn">
                        <input type="file" id="file-input" accept="image/*,.pdf" onchange="handleFileUpload(event)" style="display: none;">
                        üìé
                    </label>
                    <div class="theme-toggle" onclick="openThemeSelector()" title="change theme">üé®</div>
                </div>
            </div>
            
            <!-- Save Options (hidden by default, shown on hover or in menu) -->
            <div class="save-options-collapsed">
                <div class="save-options-toggle" onclick="toggleSaveOptions()">‚öôÔ∏è options</div>
                <div id="save-options-content" class="save-options-content" style="display: none;">
                    <div class="save-options">
                        <label><input type="radio" name="save-type" value="private" checked> private</label>
                        <label><input type="radio" name="save-type" value="public"> public</label>
                    </div>
                    <div class="password-options">
                        <label>
                            <input type="checkbox" id="protect-note"> protect with password
                        </label>
                        <input type="password" id="note-password" placeholder="note password (optional)" style="display: none;">
                    </div>
                </div>
            </div>
            
            <!-- Textarea and Preview -->
            <div class="notepad-editor-container">
                <textarea id="notepad-textarea" class="notepad-textarea" placeholder="start typing..."></textarea>
                <div id="markdown-preview" class="markdown-preview" style="display: none;"></div>
            </div>
            
            <div id="attachments" class="attachments"></div>
        </div>
    </main>
    
    <!-- Theme Selector Modal -->
    <div id="theme-modal" class="theme-modal" style="display: none;">
        <div class="theme-modal-content">
            <div class="theme-modal-header">
                <h3>select theme</h3>
                <span class="close-theme" onclick="closeThemeSelector()">&times;</span>
            </div>
            <div class="theme-options">
                <div class="theme-option" onclick="setThemeLocal('light')" data-theme="light">
                    <div class="theme-preview light-preview"></div>
                    <span>light</span>
                </div>
                <div class="theme-option" onclick="setThemeLocal('dark-pink')" data-theme="dark-pink">
                    <div class="theme-preview dark-pink-preview"></div>
                    <span>dark pink</span>
                </div>
                <div class="theme-option" onclick="setThemeLocal('blue')" data-theme="blue">
                    <div class="theme-preview blue-preview"></div>
                    <span>blue</span>
                </div>
                <div class="theme-option" onclick="setThemeLocal('green')" data-theme="green">
                    <div class="theme-preview green-preview"></div>
                    <span>green</span>
                </div>
                <div class="theme-option" onclick="setThemeLocal('purple')" data-theme="purple">
                    <div class="theme-preview purple-preview"></div>
                    <span>purple</span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/markdown.js"></script>
    <script src="../js/common.js"></script>
    <script>
        let currentNoteId = null;
        let currentNoteType = null;
        let viewMode = 'text'; // 'text' or 'markdown'
        
        // Get note ID and type from URL
        const urlParams = new URLSearchParams(window.location.search);
        currentNoteId = urlParams.get('id');
        currentNoteType = urlParams.get('type');
        
        // If creating new note
        if (!currentNoteId) {
            document.getElementById('notepad-content').style.display = 'block';
            document.getElementById('note-password').style.display = 'none';
            if (currentNoteType) {
                document.querySelector(`input[name="save-type"][value="${currentNoteType}"]`).checked = true;
            }
            document.getElementById('protect-note').addEventListener('change', function() {
                document.getElementById('note-password').style.display = this.checked ? 'block' : 'none';
            });
        } else {
            // Loading existing note
            loadNote();
        }
        
        // Update markdown preview as user types
        const textarea = document.getElementById('notepad-textarea');
        textarea.addEventListener('input', function() {
            if (viewMode === 'markdown') {
                updateMarkdownPreview();
            }
        });
        
        // Handle Tab key to insert 2 spaces
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                const value = this.value;
                
                // Insert 2 spaces at cursor position
                this.value = value.substring(0, start) + '  ' + value.substring(end);
                this.selectionStart = this.selectionEnd = start + 2;
            }
        });
        
        // Keyboard shortcuts for formatting
        textarea.addEventListener('keydown', function(e) {
            // Ctrl+B for Bold
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                applyFormatting('bold');
            }
            // Ctrl+I for Italic
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                applyFormatting('italic');
            }
            // Ctrl+U for Underline
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                applyFormatting('underline');
            }
        });
        
        function toggleMenu(menuId) {
            // Close all menus
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu.id !== menuId) {
                    menu.style.display = 'none';
                }
            });
            // Toggle current menu
            const menu = document.getElementById(menuId);
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        // Close menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-item')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
            // Close theme modal when clicking outside
            const themeModal = document.getElementById('theme-modal');
            if (e.target === themeModal) {
                closeThemeSelector();
            }
        });
        
        function toggleViewMode() {
            viewMode = viewMode === 'text' ? 'markdown' : 'text';
            const textarea = document.getElementById('notepad-textarea');
            const preview = document.getElementById('markdown-preview');
            const viewModeText = document.getElementById('view-mode-text');
            
            if (viewMode === 'markdown') {
                textarea.style.display = 'none';
                preview.style.display = 'block';
                updateMarkdownPreview();
                viewModeText.textContent = 'view: markdown';
            } else {
                textarea.style.display = 'block';
                preview.style.display = 'none';
                viewModeText.textContent = 'view: text';
            }
        }
        
        function updateMarkdownPreview() {
            const text = document.getElementById('notepad-textarea').value;
            const html = parseMarkdown(text);
            document.getElementById('markdown-preview').innerHTML = html;
        }
        
        function applyFormatting(type) {
            const textarea = document.getElementById('notepad-textarea');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            
            let formattedText = '';
            let newCursorPos = start;
            
            if (type === 'bold') {
                if (selectedText) {
                    // If text is selected, wrap it
                    formattedText = '**' + selectedText + '**';
                    newCursorPos = start + formattedText.length;
                } else {
                    // If no text selected, insert bold markers
                    formattedText = '****';
                    newCursorPos = start + 2; // Position cursor between markers
                }
            } else if (type === 'italic') {
                if (selectedText) {
                    formattedText = '*' + selectedText + '*';
                    newCursorPos = start + formattedText.length;
                } else {
                    formattedText = '**';
                    newCursorPos = start + 1;
                }
            } else if (type === 'underline') {
                // Markdown doesn't have native underline, so we'll use HTML in preview
                // For now, we'll use a workaround with <u> tags that will be rendered
                if (selectedText) {
                    formattedText = '<u>' + selectedText + '</u>';
                    newCursorPos = start + formattedText.length;
                } else {
                    formattedText = '<u></u>';
                    newCursorPos = start + 3;
                }
            }
            
            textarea.value = beforeText + formattedText + afterText;
            textarea.selectionStart = newCursorPos;
            textarea.selectionEnd = newCursorPos;
            textarea.focus();
            
            // Update preview if in markdown mode
            if (viewMode === 'markdown') {
                updateMarkdownPreview();
            }
        }
        
        function toggleSaveOptions() {
            const content = document.getElementById('save-options-content');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }
        
        function openThemeSelector() {
            document.getElementById('theme-modal').style.display = 'flex';
        }
        
        function closeThemeSelector() {
            document.getElementById('theme-modal').style.display = 'none';
        }
        
        function setThemeLocal(themeName) {
            setTheme(themeName);
            closeThemeSelector();
        }
        
        function loadNote() {
            notesAPI.getNotes(currentNoteType).then(notes => {
                const note = notes.find(n => n.id === currentNoteId);
            
                if (!note) {
                    alert('Note not found');
                    window.location.href = currentNoteType === 'public' ? 'blog.html' : 'private.html';
                    return;
                }
                
                // Check if note is password protected
                if (note.password) {
                    document.getElementById('password-prompt').style.display = 'block';
                    return;
                }
                
                displayNote(note);
            }).catch(error => {
                console.error('Error loading note:', error);
                alert('error loading note');
            });
        }
        
        function checkNotePassword() {
            const input = document.getElementById('note-password-input').value;
            notesAPI.getNotes(currentNoteType).then(notes => {
                const note = notes.find(n => n.id === currentNoteId);
                const masterPassword = getMasterPassword();
            
                if (input === note.password || input === masterPassword) {
                    document.getElementById('password-prompt').style.display = 'none';
                    displayNote(note);
                } else {
                    document.getElementById('note-password-error').textContent = 'incorrect password';
                }
            }).catch(error => {
                console.error('Error checking password:', error);
            });
        }
        
        function displayNote(note) {
            document.getElementById('password-prompt').style.display = 'none';
            document.getElementById('notepad-content').style.display = 'block';
            
            document.getElementById('note-title').value = note.title || '';
            document.getElementById('notepad-textarea').value = note.content || '';
            
            const saveType = note.type === 'public' ? 'public' : 'private';
            document.querySelector(`input[name="save-type"][value="${saveType}"]`).checked = true;
            
            if (note.password) {
                document.getElementById('protect-note').checked = true;
                document.getElementById('note-password').value = note.password;
                document.getElementById('note-password').style.display = 'block';
            }
            
            // Display attachments
            if (note.attachments && note.attachments.length > 0) {
                displayAttachments(note.attachments);
            }
            
            document.getElementById('protect-note').addEventListener('change', function() {
                document.getElementById('note-password').style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    document.getElementById('note-password').value = '';
                }
            });
        }
        
        async function saveNote() {
            const title = document.getElementById('note-title').value || 'untitled';
            const content = document.getElementById('notepad-textarea').value;
            const saveType = document.querySelector('input[name="save-type"]:checked').value;
            const protectNote = document.getElementById('protect-note').checked;
            const password = protectNote ? document.getElementById('note-password').value : '';
            
            let note = {
                id: currentNoteId || generateId(),
                title: title,
                content: content,
                type: saveType,
                date: currentNoteId ? undefined : new Date().toISOString(),
                password: password || null,
                attachments: []
            };
            
            // Preserve attachments if editing
            if (currentNoteId) {
                try {
                    const existingNote = await notesAPI.getNote(saveType, currentNoteId);
                    if (existingNote) {
                        note.date = existingNote.date;
                        note.attachments = existingNote.attachments || [];
                    }
                } catch (error) {
                    console.error('Error loading existing note:', error);
                }
            }
            
            try {
                await notesAPI.saveNote(saveType, note);
                
                // If type changed, remove from old location
                if (currentNoteId && saveType !== currentNoteType) {
                    try {
                        await notesAPI.deleteNote(currentNoteType, currentNoteId);
                    } catch (error) {
                        console.error('Error deleting from old location:', error);
                    }
                }
                
                alert('note saved!');
                window.location.href = saveType === 'public' ? 'blog.html' : 'private.html';
            } catch (error) {
                console.error('Error saving note:', error);
                alert('error saving note. please try again.');
            }
        }
        
        async function deleteNote() {
            if (!currentNoteId) return;
            
            if (confirm('Are you sure you want to delete this note?')) {
                try {
                    await notesAPI.deleteNote(currentNoteType, currentNoteId);
                    alert('note deleted!');
                    window.location.href = currentNoteType === 'public' ? 'blog.html' : 'private.html';
                } catch (error) {
                    console.error('Error deleting note:', error);
                    alert('error deleting note. please try again.');
                }
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const attachment = {
                    name: file.name,
                    type: file.type,
                    data: e.target.result,
                    size: file.size
                };
                
                if (!currentNoteId) {
                    currentNoteId = generateId();
                }
                
                const saveType = document.querySelector('input[name="save-type"]:checked').value;
                notesAPI.getNotes(saveType).then(notes => {
                    let note = notes.find(n => n.id === currentNoteId);
                    
                    if (!note) {
                        note = {
                            id: currentNoteId,
                            title: document.getElementById('note-title').value || '',
                            content: document.getElementById('notepad-textarea').value || '',
                            type: saveType,
                            date: new Date().toISOString(),
                            attachments: []
                        };
                    }
                    
                    if (!note.attachments) {
                        note.attachments = [];
                    }
                    
                    note.attachments.push(attachment);
                    notesAPI.saveNote(saveType, note).then(() => {
                        displayAttachments(note.attachments);
                    });
                });
            };
            
            if (file.type.startsWith('image/')) {
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                reader.readAsDataURL(file);
            } else {
                alert('Unsupported file type. Please upload images or PDFs.');
            }
        }
        
        function displayAttachments(attachments) {
            const container = document.getElementById('attachments');
            container.innerHTML = attachments.map((att, index) => {
                if (att.type.startsWith('image/')) {
                    return `
                        <div class="attachment-item">
                            <img src="${att.data}" alt="${att.name}" class="attachment-image">
                            <p>${att.name}</p>
                            <button onclick="removeAttachment(${index})">Remove</button>
                        </div>
                    `;
                } else if (att.type === 'application/pdf') {
                    return `
                        <div class="attachment-item">
                            <iframe src="${att.data}" class="attachment-pdf"></iframe>
                            <p>${att.name}</p>
                            <button onclick="removeAttachment(${index})">Remove</button>
                        </div>
                    `;
                }
            }).join('');
        }
        
        function removeAttachment(index) {
            if (!currentNoteId) return;
            
            const saveType = document.querySelector('input[name="save-type"]:checked').value;
            notesAPI.getNotes(saveType).then(notes => {
                const note = notes.find(n => n.id === currentNoteId);
                
                if (note && note.attachments) {
                    note.attachments.splice(index, 1);
                    notesAPI.saveNote(saveType, note).then(() => {
                        displayAttachments(note.attachments);
                    });
                }
            });
        }
        
        function createNewNote(type) {
            window.location.href = `notepad.html?type=${type}`;
        }
    </script>
</body>
</html>
